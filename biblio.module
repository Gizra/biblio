<?php 
// $Id$
/**
 * biblio.module for Drupal
 * Author:  Ron Jerome (ron.jerome@nrc.ca)
 * Released under the GPL license
 *
 */  
function biblio_help_page() {
  $text .= t('<H3>General:</H3>');
  $text .= t('By default, the <a href="/biblio">/biblio</a> page will list all 
            of the entries in the database sorted by Year in descending order.  
            If you wish to sort by "Title" or "Type",  you may do so by
            clicking on the appropriate links at the top of the page.  To 
            reverse the sort order, simply click the link a second time.');
  $text .= t('<H3>Filtering Search Results:</H3>');
  $text .= t('<P>If you wish to filter the results, click on the "Filter" tab at the
              top of the page.  To add a filter, click the radio button to the left 
              of the filter type you wish to apply, then select the filter criteria
              from the drop down list on the right, then click the filter button.</P>');
  $text .= t('<P> It is possible to create complex filters by returning to the 
              <i>"Filter"</i> tab and adding additional filters.  Simply follow the steps
              outlined above and press the "Refine" button.</P>');
  $text .= t('<P>All filters can be removed by clicking the <I>Clear All Filters</I>
              link at the top of the result page, or on the <i>"Filter"</i> tab
              they can be removed one at a time using the <i>"Undo"</i> button, or 
              you can remove them all using the <i>"Clear All"</i> button</P>');
  $text .= t('<P>You may also construct URLs which filter.  For example, /biblio/year/2005
              will show all of the entries for 2005.  /biblio/year/2005/author/smith will show
              all of entries from 2005 for smith.</P>');
  $text .= t('<H3>Exporting Search Results:</H3>');
  $text .= t('<P>Assuming this option has been enabled by the administrator, you
              can export search results directly into EndNote.  The link at the 
              top of the result page will export all of the search results, and the
              links on individual entries will export the information related
              to that single entry. </P>');
  $text .= t('<P>The information is exported in EndNote "Tagged" format similar to this...
              <pre>
              %0  Book
              %A  John Smith 
              %D  1959
              %T  The Works of John Smith
              ...
              </pre></P>');
  $text .= t('<P>Clicking on one of the export links should cause your browser to
              ask you whether you want to Open, or Save To Disk, the file endnote.enw.
              If you choose to open it, Endnote should start and ask you which library
              you would like store the results in.  Alternatively, you can save the 
              file to disk and manually import it into EndNote.</P>');

  print theme('page', $text);
} 

/**
* Implementation of hook_help().
* 
* Throughout Drupal, hook_help() is used to display help text at the top of
* pages. Some other parts of Drupal pages get explanatory text from these hooks
* as well. We use it here to provide a description of the module on the
* module administration page.
*/

function biblio_help($section) {
  switch ($section) {
    case 'admin/modules#description': 
      // This description is shown in the listing at admin/modules.
      return t('Manages a list of scholarly papers on your site');
    case 'node/add#biblio': 
      // This description shows up when users click "create content."
      return t('This allows you to add a bibliographic entry to the database');
  } 
} 

/**
* Implementation of hook_node_name().
* 
* This is a required node hook. Since our module only defines one node
* type, we won't implement hook_node_types(), and our hook_node_name()
* implementation simply returns the translated name of the node type.
*/
function biblio_node_name($node) {
  return t('biblio');
} 

/**
* Implementation of hook_access().
* 
* Node modules may implement node_access() to determine the operations
* users may perform on nodes. This example uses a very common access pattern.
*/
function biblio_access($op, $node) {
  global $user;

  if ($op == 'create') {
    // Only users with permission to do so may create this node type.
    return user_access('create biblio');
  } 
  if ($op == 'import') {
    // Only users with permission to do so may import entries from file.
    return user_access('import from file');
  } 
  // Users who create a node may edit or delete it later, assuming they have the
  // necessary permissions.
  if ($op == 'update' || $op == 'delete') {
    if (user_access('edit own biblio entries') && ($user->uid == $node->uid)) {
      return true;
    } 
  } 
} 

/**
* Implementation of hook_perm().
* 
* Since we are limiting the ability to create new nodes to certain users,
* we need to define what those permissions are here. We also define a permission
* to allow users to edit the nodes they created.
*/
function biblio_perm() {
  return array('create biblio', 'edit own biblio entries', 'import from file');
} 

/**
* Implementation of hook_link().
* 
* This is implemented so that an edit link is displayed for users who have
* the rights to edit a node.
*/
function biblio_link($type, $node = 0, $main) {
  $links = array();

  if ($type == 'node' && $node->type == 'biblio') {
    // Don't display a redundant edit link if they are node administrators.
    if (biblio_access('update', $node) && !user_access('administer nodes')) {
      $links[] = l(t('edit this entry'), "node/$node->nid/edit");
    } 
  } 

  return $links;
} 
/**
* Implementation of hook_settings().
*/
function biblio_settings() {
  $output .= form_checkbox(t('Normalize author names when displaying biblio records'),
    'biblio_normalize', 1, variable_get('biblio_normalize', 0),
    t('Tries (doesn\'t always work) to reformat author names such that thay are all in the 
                             format lastname followed by initials, e.g. Smith, J.S. 
                             (Note: This setting does not change the entry in the database, 
                             only how it is formated after it is retrieved from the database,
                             thus you can turn it on and off at will.)'));
  $output .= form_checkbox(t('Allow the export of biblio search results in EndNote "Tagged" format'), 'biblio_endnote_export', 1, variable_get('biblio_endnote_export', 0), t('This adds an export link to the search result pages.'));
  $output .= form_textfield(t('Number of results per page on biblio queries'), 'biblio_rowsperpage', variable_get('biblio_rowsperpage', 25), 6, 6, 'This limits the number of results that will be displayed on a page.  The appropriate "Next, Previous, etc. links will be added to the bottom of the page');
  return $output;
} 

/**
* Implementation of hook_menu().
* 
* Here we define some built in links for the biblio module, links exposed are:
*   /node/add/biblio      => to add a single entry
*   /biblio               => lists all entries in the biblio database
*   /biblio/list          => default local task for /biblio
*   /biblio/filter        => local task which allows users to add filters to their query
*   /biblio/filter/clear  => used internally to remove all filters
*   /biblio/help          => displays a help page
*   /biblio/export/endnote => used to export information in Endnote Tagged format
*   /biblio/import/form   => presents a form to allow the user to upload a file to import
*    
*   
*/
function biblio_menu($may_cache) {
  drupal_set_html_head('<style type="text/css">@import url(' . drupal_get_path('module', 'biblio') . '/biblio.css);</style>');

  $items = array();

  if ($may_cache) {
    $items[] = array('path' => 'node/add/biblio', 'title' => t('bibliography'),
      'access' => user_access('create biblio'));
    $items[] = array('path' => 'biblio', 'title' => t(''),
      'callback' => 'biblio_db_search',
      'access' => user_access('access content'),
      'type' => MENU_CALLBACK);
    // The next two "LOCAL TASKS" are for the admin/settings/biblio page  
    $items[] = array('path' => 'admin/settings/biblio/basic', 'title' => t('Basic'),
      'type' => MENU_DEFAULT_LOCAL_TASK, 'weight' => -10);
    $items[] = array('path' => 'admin/settings/biblio/import', 'title' => t('Import'),
      'callback' => 'biblio_import_form',
      'type' => MENU_LOCAL_TASK, 'weight' => -9);  
    $items[] = array('path' => 'biblio/list', 'title' => t('List'),
      'type' => MENU_DEFAULT_LOCAL_TASK, 'weight' => -10);
    $items[] = array('path' => 'biblio/filter', 'title' => t('Filter'),
      'callback' => 'biblio_filter_form',
      'type' => MENU_LOCAL_TASK, 'weight' => -9);
    $items[] = array('path' => 'biblio/filter/clear', 'title' => t(''),
      'callback' => 'biblio_filter_clear',
      'access' => user_access('access content'),
      'type' => MENU_CALLBACK);
    $items[] = array('path' => 'biblio/help', 'title' => t('Help'),
      'callback' => 'biblio_help_page',
      'access' => user_access('access content'),
      'type' => MENU_CALLBACK);
    $items[] = array('path' => 'biblio/export/endnote', 'title' => t(''),
      'callback' => '_endnote_tagged_export',
      'access' => user_access('access content'),
      'type' => MENU_CALLBACK);
    $items[] = array('path' => 'biblio/export/endnote7XML', 'title' => t(''),
      'callback' => '_endnote7_XML_export',
      'access' => user_access('access content'),
      'type' => MENU_CALLBACK);
    $items[] = array('path' => 'biblio/import/form', 'title' => t(''),
      'callback' => 'biblio_import_form',
      'access' => user_access('import from file'),
      'type' => MENU_CALLBACK);
  } 

  return $items;
} 
function biblio_filter_clear() {
  $_SESSION['biblio_filter'] = array();
  drupal_goto('/biblio');
} 
function biblio_filter_form() {
  $op = $_POST['op'];
  $edit = $_POST['edit'];
  $result = db_query('SELECT b.biblio_year, b.biblio_authors, t.name , t.tid FROM biblio as b  left join biblio_types as t on b.biblio_type = t.tid ORDER BY b.biblio_year DESC');
  while ($option = db_fetch_object($result)) {
    $pub_years["$option->biblio_year"] = t("$option->biblio_year");
    $pub_type["$option->tid"] = t("$option->name");
    $author_array = explode(";", $option->biblio_authors);
    foreach($author_array as $auth) {
      if (strstr($auth, ",")) {
        $parts = split(",", $auth);
        $lastname = trim($parts[0]);
      } else {
        $parts = split(" ", $auth);
        $lastname = trim(end($parts));
      } 
      if ($lastname) $pub_authors["$lastname"] = $lastname;
    } 
  } 
  $pub_years = array_unique($pub_years);
  $pub_type = array_unique($pub_type);
  ksort($pub_authors);
  $filters = array('author' => array('title' => t('Author'),
      'options' => $pub_authors),
    'type' => array('title' => t('Publication Type'),
      'options' => $pub_type),
    'year' => array('title' => t('Year'),
      'options' => $pub_years)); 
  // Initialize/reset filters
  if (!isset($_SESSION['biblio_filter']) || !is_array($_SESSION['biblio_filter']) || $op == t('Clear All')) {
    $_SESSION['biblio_filter'] = array();
  } 
  $session = &$_SESSION['biblio_filter'];
  $filter = $edit['filter'];
  if (($op == t('Filter') || $op == t('Refine')) && isset($filter)) {
    if (isset($filters[$filter]['options'][$edit[$filter]])) {
      $session[] = array($filter, $edit[$filter]);
    } 
  } 
  if ($op == t('Undo')) {
    array_pop($session);
  } 
  if ($op) { 
    drupal_goto('biblio');
  } 

  if ($op != '') {
    drupal_goto('biblio/filter');
  } 

  /*
  ** Form
  */
  $output .= '<div id="biblio-filter">'; 
  // Existing filters
  $form = '<ul>';
  $i = 0;
  foreach ($session as $filter) {
    list($type, $value) = $filter;
    $params = array('%a' => '<strong>' . $filters[$type]['title'] . '</strong>', '%b' => '<strong>' . $filters[$type]['options'][$value] . '</strong>');
    $form .= '<li>' . ($i++ ? t('<em>and</em> where <strong>%a</strong> is <strong>%b</strong>', $params) : t('<strong>%a</strong> is <strong>%b</strong>', $params)) . '</li>';
  } 

  $values = '';
  $options = array();
  foreach ($filters as $key => $value) {
    $options[$key] = $value['title'];
    $b .= form_select('', $key, 1, $filters[$key]['options']);
  } 

  $buttons = '';
  if (count($options)) {
    $form .= '<li><dl class="biblio_multiselect">';
    $a = '';
    foreach ($options as $key => $value) {
      $a .= form_radio($value, 'filter', $key);
    } 
    if (!$i) {
      $form .= t('<dd class="a">%a</dd> <dt>is</dt> <dd class="b">%b</dd>', array('%a' => $a, '%b' => $b));
    } else {
      $form .= t('<dt><em>and</em> where</dt> <dd class="a">%a</dd> <dt>is</dt> <dd class="b">%b</dd>', array('%a' => $a, '%b' => $b));
    } 
    $form .= '</dl>';
    $buttons = form_submit(count($session) ? t('Refine') : t('Filter'));
  } 
  if (count($session)) {
    $buttons .= form_submit(t('Undo')) . form_submit(t('Clear All'));
  } 
  $form .= '<div class="container-inline" id="biblio-buttons">' . $buttons . '</div>';
  $form .= '</li></ul><br class="clear" />';
  $output .= form_group(t('Show only items where'), $form) . '</div>';

  print theme('page', form($output));
} 
function biblio_search_form() {
  // print_r($_POST);
  if ($_POST['op'] == 'Search') {
    $edit = $_POST['edit']; 
    // print_r($_POST);
    biblio_search($edit['test']);
  } else {
    $form = form_textfield('Test', 'test', '', 10, 10);
    $form .= form_submit('Search');
    $group = form_group("test group", $form);
    print theme('page', form($group));
  } 
} 
/**
* Implementation of hook_form().
* 
* Create the form for collecting the information
* specific to this node type. This hook requires us to return some HTML
* that will be later placed inside the form.
*/
function biblio_form(&$node, &$param) {
  $output = '';
  $param['options'] = array("enctype" => "multipart/form-data"); 
  // print_r($node);
  // In order to be able to attach taxonomy terms to this node, we need
  // to display the appropriate form elements.
  if (function_exists('taxonomy_node_form')) {
    $output .= implode('', taxonomy_node_form('biblio', $node));
  } 
  // Now we define the form elements specific to our node type.
  // $output .= form_textarea(t('Body'), 'body', $node->body, 60, 20);
  // $output .= filter_form('format', $node->format);
  $result = db_query('SELECT t.* FROM {biblio_types as t}');
  while ($option = db_fetch_object($result)) {
    $options["$option->tid"] = t("$option->name");
  } 

  $output .= form_select(t('Publication Type'), 'biblio_type', $node->biblio_type, $options, null, 'onchange="document.getElementById(\'node-form\').submit()"', false, true);

  if (isset($node->biblio_type) && $node->biblio_type > 0) {
    $output .= form_textfield(t('Authors'), 'biblio_authors', $node->biblio_authors,
      60, 128,
      'Author names must be separated by semicolons', 0, true);
    $output .= form_textfield(t('Year of Publication'), 'biblio_year', $node->biblio_year, 10, 10, '(YYYY)', 0, true);

    switch ($node->biblio_type) {
      case 1: // Journal Paper
        $output .= form_textfield(t('Journal Title'), 'biblio_secondary_title', $node->biblio_secondary_title, 60, 255, 0, 0, true);
        $output .= form_textfield(t('Volume'), 'biblio_volume', $node->biblio_volume, 60, 128);
        $output .= form_textfield(t('Issue'), 'biblio_issue', $node->biblio_issue, 60, 128);
        $output .= form_textfield(t('Pagination'), 'biblio_pages', $node->biblio_pages, 60, 128);
        $output .= form_textfield(t('Journal Date'), 'biblio_date', $node->biblio_date, 60, 128, '(mm/yyyy)');
        break;
      case 2: // Refereed Conference Paper
      case 3: // Non-Refereed Conference Paper
      case 4: // Non-Refereed Conference Poster
        $output .= form_textfield(t('Conference Name'), 'biblio_secondary_title', $node->biblio_secondary_title, 60, 255, 0, 0, true);
        $output .= form_textfield(t('Conference Location'), 'biblio_place_published', $node->biblio_place_published, 60, 128);
        $output .= form_textfield(t('Publisher'), 'biblio_publisher', $node->biblio_publisher, 60, 128);
        $output .= form_textfield(t('Volume'), 'biblio_volume', $node->biblio_volume, 60, 128);
        $output .= form_textfield(t('Pagination'), 'biblio_pages', $node->biblio_pages, 60, 128);
        $output .= form_textfield(t('Series Title'), 'biblio_tertiary_title', $node->biblio_tertiary_title, 60, 128);
        $output .= form_textfield(t('Series Editor'), 'biblio_tertiary_authors', $node->biblio_tertiary_authors, 60, 128);
        $output .= form_textfield(t('Edition'), 'biblio_edition', $node->biblio_edition, 60, 128);
        $output .= form_textfield(t('Conference Start Date'), 'biblio_date', $node->biblio_date, 60, 128, '(dd/mm/yyyy)');
        break;
      case 5: // Report
        $output .= form_textfield(t('Prepared for / Presented at'), 'biblio_secondary_title', $node->biblio_secondary_title, 60, 255, 0, 0, true);
        $output .= form_textfield(t('City'), 'biblio_place_published', $node->biblio_place_published, 60, 128);
        $output .= form_textfield(t('Institution'), 'biblio_publisher', $node->biblio_publisher, 60, 128);
        $output .= form_textfield(t('Pages'), 'biblio_pages', $node->biblio_pages, 60, 128);
        $output .= form_textfield(t('Date'), 'biblio_date', $node->biblio_date, 60, 128, '(dd/mm/yyyy)');

        break;
      case 6: // Book or Book Chapter
        $output .= form_textfield(t('Editor'), 'biblio_secondary_authors', $node->biblio_secondary_authors, 60, 128);
        $output .= form_textfield(t('Book Title'), 'biblio_secondary_title', $node->biblio_secondary_title, 60, 255, 0, 0, true);
        $output .= form_textfield(t('Pages'), 'biblio_pages', $node->biblio_pages, 60, 128);
        $output .= form_textfield(t('Series Title'), 'biblio_tertiary_title', $node->biblio_tertiary_title, 60, 128);
        $output .= form_textfield(t('Series Editor'), 'biblio_tertiary_authors', $node->biblio_tertiary_authors, 60, 128);
        $output .= form_textfield(t('Edition'), 'biblio_edition', $node->biblio_edition, 60, 128);
        $output .= form_textfield(t('Publisher'), 'biblio_publisher', $node->biblio_publisher, 60, 128);
        $output .= form_textfield(t('Place of Publication'), 'biblio_place_published', $node->biblio_place_published, 60, 128);
        break;
      case 7: // Thesis
        $output .= form_textfield(t('Academic Department'), 'biblio_secondary_title', $node->biblio_secondary_title, 60, 255, 0, 0, true);
        $output .= form_textfield(t('City'), 'biblio_place_published', $node->biblio_place_published, 60, 128);
        $output .= form_textfield(t('University'), 'biblio_publisher', $node->biblio_publisher, 60, 128);
        $output .= form_textfield(t('Degree'), 'biblio_pages', $node->biblio_type_of_work, 24, 24);
        $output .= form_textfield(t('Number of Pages'), 'biblio_pages', $node->biblio_pages, 60, 128);

        break;
      case 8: // Patent
        $output .= form_textfield(t('Published Source'), 'biblio_secondary_title', $node->biblio_secondary_title, 60, 255, 0, 0, true);
        $output .= form_textfield(t('Country'), 'biblio_place_published', $node->biblio_place_published, 60, 128);
        $output .= form_textfield(t('Assignee'), 'biblio_publisher', $node->biblio_publisher, 60, 128);
        $output .= form_textfield(t('Volume'), 'biblio_volume', $node->biblio_volume, 60, 128);
        $output .= form_textfield(t('Issue'), 'biblio_issue', $node->biblio_issue, 60, 128);
        $output .= form_textfield(t('Pages'), 'biblio_pages', $node->biblio_pages, 60, 128);
        $output .= form_textfield(t('Date'), 'biblio_date', $node->biblio_date, 60, 128, '(dd/mm/yyyy)');

        break;
      case 9: // Other
        $output .= form_textfield(t('Prepared for / Presented at'), 'biblio_secondary_title', $node->biblio_secondary_title, 60, 255, 0, 0, true);

        break;
    } //end switch  
    // now output the fields common to all types...
    $output .= form_textfield(t('Key Words'), 'biblio_keywords', $node->biblio_keywords, 60, 255);
    $output .= form_textarea(t('Abstract'), 'biblio_abst_e', $node->biblio_abst_e, 60, 15);
    $output .= form_textfield(t('ISBN/ISSN Number'), 'biblio_isbn', $node->biblio_isbn, 24, 24);
    $output .= form_textfield(t('Call Number'), 'biblio_call_number', $node->biblio_call_number, 24, 24);
    $output .= form_textfield(t('Accession Number'), 'biblio_accession_number', $node->biblio_accession_number, 24, 24);
    $output .= form_textfield(t('Other Numbers'), 'biblio_other_number', $node->biblio_other_number, 24, 24);
    $output .= form_textfield(t('URL'), 'biblio_url', $node->biblio_url, 120, 120);
    $output .= form_textfield(t('Notes'), 'biblio_notes', $node->biblio_notes, 120, 120);
    $output .= "<div id='message'><div class='messages error'><B><blink>NOTE:</blink> Do not attach copies of papers for which you do not <u>own</u> the copyright!</b></div></div>"; 
    // $output .= form_item('Note: please do not attach copies of papers for which you do not own the copyright');
    // $output .= form_file('Associated File', 'biblio_file', 30, 'You may attach a file of any format (Word, PDF, etc.) to this entry') ;
  } //endif
  return $output;
} 

/**
* Implementation of hook_validate().
* 
* 
* Errors should be signaled with form_set_error().
*/
function biblio_validate(&$node) {
  if ($node->biblio_type == 0) {
    form_set_error('biblio_type', t('You must select the type of publication'));
    return;
  } 
  if (!$node->biblio_authors) {
    form_set_error('biblio_authors', t('You must supply at least one author name'));
  } 
  /*  if (!strstr("$node->biblio_authors", ";")) {
    form_set_error('biblio_authors', t('You must separate the author names with semicolons'));
  } 
*/
  if (!$node->biblio_year) {
    form_set_error('biblio_year', t('You must supply the year of publication'));
  } else {
    $today = getdate();
    if ($node->biblio_year < 1900 || $node->biblio_year > $today['year'])
      form_set_error('biblio_year', t('Year of Publication must be a number between 1900 and ' . $today['year']));
  } 
  /*  if (!$node->biblio_secondary_title) {
    form_set_error('biblio_secondary_title', t('You must supply the Journal Title, Conference Name or Book Title'));
  } 
*/

} 

/**
* Implementation of hook_insert().
* 
* As a new node is being inserted into the database, we need to do our own
* database inserts.
*/
function biblio_insert($node) {
  // Prepare the query:
  $fields = biblio_get_db_fields();
  foreach ($node as $key => $value) {
    if (in_array((string) $key, $fields)) {
      $k[] = db_escape_string($key);
      $v[] = $value;
      $s[] = "'%s'";
    } 
  } 
  // Insert the node into the database:
  db_query("INSERT INTO {biblio} (" . implode(", ", $k) . ") VALUES(" . implode(", ", $s) . ")", $v);
} 

/**
* Implementation of hook_update().
* 
* As an existing node is being updated in the database, we need to do our own
* database updates.
*/
function biblio_update($node) {
  $fields = biblio_get_db_fields();
  foreach ($node as $key => $value) {
    if (in_array($key, $fields)) {
      $q[] = db_escape_string($key) . " = '%s'";
      $v[] = $value;
    } 
  } 
  // Update the node in the database:
  db_query("UPDATE {biblio} SET " . implode(', ', $q) . " WHERE nid = '$node->nid'", $v);
} 

/**
* Implementation of hook_delete().
* 
* When a node is deleted, we need to clean up related tables.
*/
function biblio_delete($node) {
  db_query('DELETE FROM {biblio} WHERE nid = %d', $node->nid);
} 

/**
* Implementation of hook_load().
* 
* This hook is called
* every time a node is loaded, and allows us to do some loading of our own.
* 
*/
function biblio_load($node) {
  $additions = db_fetch_object(db_query('SELECT * FROM {biblio} WHERE nid = %d', $node->nid));
  return $additions;
} 

/**
* Implementation of hook_view().
* 
* This is a typical implementation that simply runs the node text through
* the output filters.
*/
function biblio_view(&$node, $teaser = false, $page = false) {
  $biblio_info = theme('biblio_long', $node);
  $node->body .= $biblio_info;
  $node->teaser .= $biblio_info; 
  // $node = node_prepare($node, $teaser);
} 

/**
* Implementation of hook_block().
* 
* Generates a block containing the latest poll.
*/
function biblio_block($op = 'list', $delta = 0) {
  if (user_access('access content')) {
    if ($op == 'list') {
      $blocks[0]['info'] = t('Most recent publications');
      return $blocks;
    } else if ($op == 'view') {
      // Retrieve the latest pubs
      // $sql = "SELECT n.title FROM (node) n WHERE n.type = 'biblio' ORDER BY n.created DESC"
      $result = db_query_range(db_rewrite_sql("SELECT n.title, n.nid FROM node AS n WHERE n.type = 'biblio' ORDER BY n.created DESC"), 0, 4);
      if (db_num_rows($result)) {
        $block['subject'] = t('New Publications');
        $block['content'] .= '<div class="item-list"><ul>';
        while ($pub = db_fetch_object($result)) {
          $block['content'] .= '<li >' . l("$pub->title", "node/$pub->nid") . '</li>';
        } 
        $block['content'] .= '</ul></div>';
      } 
      return $block;
    } 
  } 
} 

function theme_biblio_long($pub) {
  if (variable_get('biblio_normalize', 0)) {
    $authors = _parse_authors($pub->biblio_authors);
  } else {
    $authors = $pub->biblio_authors;
  } 

  $output .= '<div class="biblio_authors"><H3>'.t("Authors").':</H3> ' . _author_links($authors) . "</div>\n";
  $output .= '<div class="biblio_source"><H3>'.t("Source").': </H3> ';
  $source = null;
  if ($pub->biblio_secondary_title) $source .= $pub->biblio_secondary_title;
  if ($pub->biblio_publisher) {
    $source .= $source?", ":"";
    $source .= $pub->biblio_publisher;
  } 
  if ($pub->biblio_volume) {
    $source .= $source?", ":"";
    $source .= t('Volume ') . $pub->biblio_volume;
  } 
  if ($pub->biblio_issue) {
    $source .= $source?", ":"";
    $source .= t('Issue ') . $pub->biblio_issue;
  } 
  if ($pub->biblio_number) {
    $source .= $source?", ":"";
    $source .= t('Number ') . $pub->biblio_number;
  } 

  if ($pub->biblio_place_published) {
    $source .= $source?", ":"";
    $source .= $pub->biblio_place_published;
  } 
  if ($pub->biblio_pages) {
    $source .= $source?", ":"";
    $source .= 'p.' . $pub->biblio_pages;
  } 
  if ($pub->biblio_year) {
    $source .= ' (' . $pub->biblio_year . ')';
  } 
  $output .= "$source</div>\n";

  if ($pub->biblio_isbn) $output .= '<h3>'.t("ISBN").':</h3> ' . check_plain($pub->biblio_isbn) . "\n";
  if ($pub->biblio_call_number) $output .= '<h3>'.t("Call Number").':</h3> ' . check_plain($pub->biblio_call_number) . "\n";
  if ($pub->biblio_accession_number) $output .= '<h3>'.t("Accession Number").':</h3> ' . check_plain($pub->biblio_accession_number) . "\n";
  if ($pub->biblio_other_number) $output .= '<h3>'.t("Other Number").':</h3> ' . check_plain($pub->biblio_other_number) . "\n";
  if ($pub->biblio_url) $output .= '<h3>'.t("URL").':</h3><a href="' . check_url($pub->biblio_url) . '">' . $pub->biblio_url . "</a>\n";
  if ($pub->biblio_keywords) $output .= '<h3>'.t("Keywords").':</h3> ' . check_plain($pub->biblio_keywords) . "\n";
  if ($pub->biblio_abst_e) $output .= '<H3>'.t("Abstract").':</h3> ' . check_plain($pub->biblio_abst_e) . "\n";
  if ($pub->biblio_notes) $output .= '<h3>'.t("Notes").': </h3>' . check_plain($pub->biblio_notes) . "\n";
  if (variable_get('biblio_endnote_export', 0)) {
    $output .= '<br><br><B>'.t("Export").':</B><a href="biblio/export/endnote/' . $pub->nid . '">Tagged</a>';
    $output .= '<a href="biblio/export/endnote7XML/' . $pub->nid . '"> XML</a>';
  } 

  return $output;
} 

function theme_biblio_short($pub) {
  if (variable_get('biblio_normalize', 0)) {
    $authors = _parse_authors($pub->biblio_authors);
  } else {
    $authors = $pub->biblio_authors;
  } 
  $output .= '<span class="biblio-title">' . l("$pub->title", "node/$pub->nid") . "</span> \n";
  $output .= '<span class="biblio-authors">' . _author_links($authors) . "</span> \n";
  if ($pub->biblio_secondary_title) {
    $output .= ', ' . $pub->biblio_secondary_title;
  } 
  if ($pub->biblio_date) $output .= ', ' . $pub->biblio_date;
  if ($pub->biblio_volume) $output .= ', Volume ' . $pub->biblio_volume;
  if ($pub->biblio_issue) $output .= ', Issue ' . $pub->biblio_issue;
  if ($pub->biblio_number) $output .= ', Number ' . $pub->biblio_number;

  if ($pub->biblio_place_published) $output .= ', ' . $pub->biblio_place_published;
  if ($pub->biblio_pages) $output .= ', p.' . $pub->biblio_pages;
  if ($pub->biblio_year) $output .= ', (' . $pub->biblio_year . ")\n";
  if ($pub->biblio_abst_e) $output .= l("Abstract", "node/$pub->nid") . "\n";
  if (variable_get('biblio_endnote_export', 0)) {
    $output .= '<b>Export:</b> <a href="biblio/export/endnote/' . $pub->nid . '">Tagged</a>';
    $output .= '<a href="biblio/export/endnote7XML/' . $pub->nid . '"> XML</a>';
  } 
  return $output;
} 

function biblio_show_results($result, $attrib = array("sort" => 'year', 'order' => 'DESC'), $args = null) {
  global $pager_total;
  $pub_types = db_query('SELECT t.* FROM {biblio_types as t} WHERE t.tid>0');
  while ($option = db_fetch_object($pub_types)) {
    $pub_type["$option->tid"] = t("$option->name");
  } 
  // Add some links to the top of the page to change the sorting/ordering...
  $order = ($attrib['order'] == "desc" || $attrib['order'] == "DESC")?"asc":"desc";
  if (variable_get('biblio_endnote_export', 0)) {
    $content .= '<div class="biblio_export">Export (' . $pager_total[0] . ') results in Endnote <a href="biblio/export/endnote">Tagged </a> or <a href="biblio/export/endnote7XML">XML</a></div>';
  } 
  $content .= '<div class="biblio_sort">Sort by: 
                 <a href="' . $_GET["q"] . '?sort=year&order=' . $order . '" title="Click a second time to reverse the sort order">' . 'Year</a> 
                 <a href="' . $_GET["q"] . '?sort=title&order=' . $order . '" title="Click a second time to reverse the sort order">' . 'Title </a>
                 <a href="' . $_GET["q"] . '?sort=type&order=' . $order . '" title="Click a second time to reverse the sort order">' . "Type </a>
                </div> ";
  $session = &$_SESSION['biblio_filter'];
  if (count($args)) {
    $content .= '<b>Filters: </b>';
    while ($args) {
      $type = $args[0];
      array_shift($args);
      $value = db_escape_string($args[0]);
      if ($type == 'type') $value = $pub_type["$value"];
      array_shift($args);
      $params = array('%a' => '<strong>' . $type . '</strong>', '%b' => '<strong>' . $value . '</strong>');
      $content .= ($i++ ? t('<em> and</em> <strong>%a</strong> is <strong>%b</strong>', $params) : t('<strong>%a</strong> is <strong>%b</strong>', $params)) . '</li>';
    } 
    $content .= '  <a href="/biblio/filter/clear">Clear All Filters</a>';
  } while ($pub = db_fetch_object($result)) {
    switch ($attrib['sort']) {
      case 'title':
        if ($pub->title {
            0} != $_char) {
          $_char = $pub->title {
            0} ;
          $content .= '<div class="biblio-year">' . $_char . "</div>\n";
        } 
        break;
      case 'type':
        if ($pub->biblio_type != $_type) {
          $_type = $pub->biblio_type;
          $name = db_result(db_query("SELECT name FROM {biblio_types as t} where t.tid=" . $pub->biblio_type)) ;
          $content .= '<div class="biblio-year">' . $name . "</div>\n";
        } 
        break;
      case 'year':
      default:
        if ($pub->biblio_year != $_year) {
          $_year = $pub->biblio_year;
          $content .= '<div class="biblio-year">' . $_year . "</div>\n";
        } 
    } //end switch
    $content .= '<div class="biblio-entry">' . "\n";
    $content .= theme('biblio_short', $pub);
    $content .= "</div>\n";
  } //end while
  $content .= theme('pager', 0, variable_get('biblio_rowsperpage', 25), 0, $attrib);
  if (!db_num_rows($result)) $content .= t("<H3>No items found</H3>");
  if (strstr($content, "Filters:")) {
    $content .= t('<a href="/biblio/filter">Modify</a>
                   or <a href="/biblio/filter/clear">remove</a> your filters and try again.');
  } 
  print theme('page', $content);
} 

function biblio_db_search() {
  $pager_attrib = array("sort" => 'year', 'order' => 'DESC');
  $limits = null;

  $params = array('sort', 'order');
  foreach ($params as $param) {
    if (isset($_GET[$param])) {
      $pager_attrib["$param"] = $_GET[$param];
    } 
  } 

  switch ($pager_attrib['sort']) {
    case 'type':
      $sortby = "ORDER BY b.biblio_type " . $pager_attrib['order'] . ", b.biblio_year DESC, substr(n.title,1,1) ASC ";
      break;
    case 'title':
      $sortby = "ORDER BY substr(n.title,1,1) " . $pager_attrib['order'] . ", b.biblio_year DESC ";
      break;
    case 'year':
    default:
      $sortby = "ORDER BY b.biblio_year " . $pager_attrib['order'] . ", substr(n.title,1,1) ASC, b.biblio_type ASC ";
  } //end switch
  if (!isset($_SESSION['biblio_filter']) || !is_array($_SESSION['biblio_filter'])) {
    $_SESSION['biblio_filter'] = array();
  } 

  $session = &$_SESSION['biblio_filter'];
  $numargs = func_num_args();
  $arg_list = func_get_args();
  foreach ($session as $filter) {
    $arg_list = array_merge($arg_list, $filter);
  } 
  if (count($arg_list) >= 2) {
    $args = array();
    while ($arg_list) {
      $type = $arg_list[0];
      array_shift($arg_list);
      switch ($type) {
        case 'author':
          $term = db_escape_string($arg_list[0]);
          array_shift($arg_list);
          $limit .= " AND MATCH(b.biblio_authors) AGAINST('$term'  IN BOOLEAN MODE)";
          array_push($args, $type, $term);
          break;
        case 'year':
          $term = db_escape_string($arg_list[0]);
          array_shift($arg_list);
          $limit .= " AND b.biblio_year='" . (int)$term . "'";
          array_push($args, $type, $term);
          break;
        case 'type':
          $term = db_escape_string($arg_list[0]);
          array_shift($arg_list);
          $limit .= " AND b.biblio_type='" . (int)$term . "'";
          array_push($args, $type, $term);
          break;
        case 'order':
          $term = db_escape_string($arg_list[0]);
          array_shift($arg_list);
          $pager_attrib['order'] = $term;
          array_push($args, $type, $term);
          break;
        case 'sort':
          $term = db_escape_string($arg_list[0]);
          array_shift($arg_list);
          $pager_attrib['sort'] = $term;
          array_push($args, $type, $term);
          switch ($term) {
            case 'type':
              $sortby = "ORDER BY b.biblio_type " . $pager_attrib['order'] . ", b.biblio_year DESC, substr(n.title,1,1) ASC ";
              break;
            case 'title':
              $sortby = "ORDER BY substr(n.title,1,1) " . $pager_attrib['order'] . ", b.biblio_year DESC ";
              break;
            case 'year':
            default:
              $sortby = "ORDER BY b.biblio_year " . $pager_attrib['order'] . ", substr(n.title,1,1) ASC, b.biblio_type ASC ";
          } //end switch
          break;
      } 
    } 
  } 
  $query = "SELECT * FROM node n left join biblio b  on n.nid=b.nid 
            WHERE n.type='biblio' $limit $sortby ";
  db_escape_string($query);
  $_SESSION['last_biblio_query'] = $query;

  $result = pager_query(db_rewrite_sql($query), variable_get('biblio_rowsperpage', 25));

  biblio_show_results($result, $pager_attrib, $args);
} 

function _endnote7_XML_export($nid = null) {
if (extension_loaded('domxml')) {
  if ($nid == null) {
    $query = $_SESSION['last_biblio_query'];
  } else {
    $query = "SELECT * FROM node n left join biblio b  on n.nid=b.nid 
                WHERE n.nid=$nid ";
  } 

  $result = db_query(db_rewrite_sql($query));

  if (db_num_rows($result)) {
    $doc = domxml_new_doc("1.0");
    $root = $doc->add_root("XML");
    $records = $root->new_child("RECORDS", "");
    while ($pub = db_fetch_object($result)) {
      $record = $records->new_child("RECORD", "");
      switch ($pub->biblio_type) {
        case 1: $reftype = 0;
          break; // journal
        case 2: // 2,3 and 4
        case 3: // are all
        case 4: $reftype = 3;
          break; // conference proceedings 
        case 5: $reftype = 10;
          break; // report
        case 6: $reftype = 7;
          break; // book section
        case 7: $reftype = 2;
          break; // thesis
        case 8: $reftype = 15;
          break; // patent
        case 9:
        default:
          $reftype = 31;
          break; // generic
      } 
      $record->new_child("REFERENCE_TYPE", "$reftype");
      $record->new_child("YEAR", trim($pub->biblio_year));
      $record->new_child("TITLE", trim($pub->title));
      $authors = $record->new_child("AUTHORS", "");
      if (variable_get('biblio_normalize', 0)) {
        $pub_authors = _parse_authors($pub->biblio_authors);
      } else {
        $pub_authors = $pub->biblio_authors;
      } 
      $author_array = explode(";", $pub_authors);
      foreach($author_array as $auth) {
        $authors->new_child("AUTHOR", trim($auth));
      } 
      if ($pub->biblio_secondary_authors) {
        $sec_authors = $record->new_child("SECONDARY_AUTHORS", "");
        $author_array = explode(";", $pub->biblio_secondary_authors);
        foreach($author_array as $auth) {
          $sec_authors->new_child("SECONDARY_AUTHOR", trim($auth));
        } 
      } 
      if ($pub->biblio_tertiary_authors) {
        $ter_authors = $record->new_child("TERTIARY_AUTHORS", "");
        $author_array = explode(";", $pub->biblio_tertiary_authors);
        foreach($author_array as $auth) {
          $ter_authors->new_child("TERTIARY_AUTHOR", trim($auth));
        } 
      } 
      if ($pub->biblio_secondary_title) $record->new_child("SECONDARY_TITLE", htmlspecialchars($pub->biblio_secondary_title));
      if ($pub->biblio_place_published) $record->new_child("PLACE_PUBLISHED", "$pub->biblio_place_published");
      if ($pub->biblio_publisher) $record->new_child("PUBLISHER", htmlspecialchars($pub->biblio_publisher));
      if ($pub->biblio_volume) $record->new_child("VOLUME", "$pub->biblio_volume");
      if ($pub->biblio_issue) $record->new_child("NUMBER", "$pub->biblio_issue");
      if ($pub->biblio_pages) $record->new_child("PAGES", "$pub->biblio_pages");
      if ($pub->biblio_tertiary_title) $record->new_child("TERTIARY_TITLE", "$pub->biblio_tertiary_title");
      if ($pub->biblio_edition) $record->new_child("EDITION", "$pub->biblio_edition");
      if ($pub->biblio_date) $record->new_child("DATE", "$pub->biblio_date");
      if ($pub->biblio_isbn) $record->new_child("ISBN", "$pub->biblio_isbn");
      if ($pub->biblio_keywords) {
        $keywords = $record->new_child("KEYWORDS", "");
        $splitchar = (strstr($pub->biblio_keywords, ";"))?";":" ";
        $kw_array = explode($splitchar, $pub->biblio_keywords);
        foreach($kw_array as $kw) {
          $keywords->new_child("KEYWORD", trim($kw));
        } 
      } 
      if ($pub->biblio_abst_f) $record->new_child("ABSTRACT", trim($pub->biblio_abst_f));
      if ($pub->biblio_abst_e) $record->new_child("ABSTRACT", trim($pub->biblio_abst_e));
      if ($pub->biblio_url) $record->new_child("URL", htmlentities($pub->biblio_url));
      if ($pub->biblio_notes) $record->new_child("NOTES", trim($pub->biblio_notes));

    } 
  } 
  header('Content-type: application/xml');
  header('Content-Disposition: attachment; filename="endnote7.xml"');
  echo $doc->dump_mem();
 }else{
   print theme("page","DOMXML php extension is not loaded, so the item cannot be exported in XML format");
}
} 

function _endnote_tagged_export($nid = null) {
  if ($nid == null) {
    $query = $_SESSION['last_biblio_query'];
  } else {
    $query = "SELECT * FROM node n left join biblio b  on n.nid=b.nid 
                WHERE n.nid=$nid ";
  } 

  $result = db_query(db_rewrite_sql($query));

  if (db_num_rows($result)) {
    $doc = "";
    while ($pub = db_fetch_object($result)) {
      switch ($pub->biblio_type) {
        case 1: $doc .= "%0 Journal Article\r\n";
          if ($pub->biblio_secondary_title) $doc .= "%J " . trim($pub->biblio_secondary_title) . "\r\n";
          break; // journal
        case 2: $doc .= "%0 Conference Paper\r\n";
          if ($pub->biblio_secondary_title) $doc .= "%B " . trim($pub->biblio_secondary_title) . "\r\n";
          break;
        case 3: // are all
        case 4: $doc .= "%0 Conference Proceedings\r\n";
          if ($pub->biblio_secondary_title) $doc .= "%B " . trim($pub->biblio_secondary_title) . "\r\n";
          break; // conference proceedings 
        case 5: $doc .= "%0 Report\r\n";
          break; // report
        case 6: $doc .= "%0 Book Section\r\n";
          if ($pub->biblio_secondary_title) $doc .= "%B " . trim($pub->biblio_secondary_title) . "\r\n";
          break; // book section
        case 7: $doc .= "%0 Thesis\r\n";
          if ($pub->biblio_secondary_title) $doc .= "%B " . trim($pub->biblio_secondary_title) . "\r\n";
          break; // thesis
        case 8: $doc .= "%0 Patent\r\n";
          if ($pub->biblio_secondary_title) $doc .= "%B " . trim($pub->biblio_secondary_title) . "\r\n";
          break; // patent
        case 9:
        default:
          $doc .= "%0 Generic\r\n";
          break; // generic
      } 
      $doc .= "%D " . trim($pub->biblio_year) . "\r\n";
      $doc .= "%T " . trim($pub->title) . "\r\n";
      if (variable_get('biblio_normalize', 0)) {
        $pub_authors = _parse_authors($pub->biblio_authors);
      } else {
        $pub_authors = $pub->biblio_authors;
      } 
      $author_array = explode(";", $pub_authors);
      foreach($author_array as $auth) {
        $doc .= "%A " . trim($auth) . "\r\n";
      } 

      if ($pub->biblio_place_published) $doc .= "%C " . trim($pub->biblio_place_published) . "\r\n";
      if ($pub->biblio_secondary_authors) {
        $author_array = explode(";", $pub->biblio_secondary_authors);
        foreach($author_array as $auth) {
          $doc .= "%E " . trim($auth) . "\r\n";
        } 
      } 
      if ($pub->biblio_publisher) $doc .= "%I " . trim($pub->biblio_publisher) . "\r\n";
      if ($pub->biblio_keywords) $doc .= "%K " . trim($pub->biblio_keywordsn) . "\r\n";
      if ($pub->biblio_call_number) $doc .= "%L " . trim($pub->biblio_call_number) . "\r\n";
      if ($pub->biblio_accession_number) $doc .= "%M " . trim($pub->biblio_accession_number) . "\r\n";
      if ($pub->biblio_issue) $doc .= "%N " . trim($pub->biblio_issue) . "\r\n";
      if ($pub->biblio_pages) $doc .= "%P " . trim($pub->biblio_pages) . "\r\n";
      if ($pub->biblio_tertiary_title) $doc .= "%S " . trim($pub->biblio_tertiary_title) . "\r\n";
      if ($pub->biblio_url) $doc .= "%U " . trim($pub->biblio_url) . "\r\n";
      if ($pub->biblio_volume) $doc .= "%V " . trim($pub->biblio_volume) . "\r\n";
      $abst = "";
      if ($pub->biblio_abst_e) $abst .= trim($pub->biblio_abst_e);
      if ($pub->biblio_abst_f) $abst .= trim($pub->biblio_abst_f);
      if ($abst) {
        $search = array("/\r/", "/\n/");
        $replace = " ";
        $abst = preg_replace($search, $replace, $abst);
        $doc .= "%X " . $abst . "\r\n";
      } 
      if ($pub->biblio_tertiary_authors) {
        $author_array = explode(";", $pub->biblio_tertiary_authors);
        foreach($author_array as $auth) {
          $doc .= "%Y " . trim($auth) . "\r\n";
        } 
      } 
      if ($pub->biblio_notes) $doc .= "%Z " . trim($pub->biblio_notes) . "\r\n";
      if ($pub->biblio_edition) $doc .= "%7 " . trim($pub->biblio_edition) . "\r\n";
      if ($pub->biblio_date) $doc .= "%8 " . trim($pub->biblio_date) . "\r\n";
      if ($pub->biblio_type_of_work) $doc .= "%9 " . trim($pub->biblio_type_of_work) . "\r\n";
      if ($pub->biblio_isbn) $doc .= "%@ " . trim($pub->biblio_isbn) . "\r\n";

      $doc .= "\r\n";
    } 
  } 
  header('Content-type: 	application/x-endnote-refer');
  header('Content-Disposition:  filename="endnote.enw"');
  print utf8_decode($doc);
} 

function biblio_import_form() {
  if (biblio_access('import', $node)) { // && !user_access('administer nodes')) {
    $op = $_POST['op'];
    $filetype = $_POST['edit']['filetype'];
    $attributes = array("enctype" => "multipart/form-data");
    if($op == Import && $filetype == '') drupal_set_message("You must select a file type",'error');
    if ($op == Import && $filetype) {
      $import = file_check_upload('import');
      if ($import) {
        $import = file_save_upload($import);
        drupal_set_message("File was successfully uploaded", 'status');
        if ($filetype == 'tagged') _endnote_tagged_import($import->filepath);
        if ($filetype == 'xml') _endnote7_XML_import($import->filepath);
        file_delete($import->filepath);
      } else {
        drupal_set_message("File was NOT successfully uploaded", 'error');
      } 
      print theme('page', "");
    } else {
      $form = "";
      $form .= form_file(t('Import Endnote file'), "import", 60); 
      $form .= form_radios(t('File Type'), 'filetype', $edit['filetype'], array('tagged' => t('EndNote Tagged') , 'xml'=>t('EndNote 7 XML')));
      $form .= form_button(t('Import'));
      print theme('page', form($form, 'post', null, $attributes));
    } 
  } else {
    drupal_set_message("You are not authorized to access the biblio import page", 'error');

    print theme('page', '');
  } 
} 

function _endnote_tagged_import($filename = null) {
  global $user;
  $node_array = array();
  $node = array();
  $node['type'] = "biblio";
  $node['created'] = time();
  $node['changed'] = time();
  $node['comment'] = 0;
  $node['promote'] = 0;
  $node['moderate'] = 0;
  $node['sticky'] = 0;
  $node['format'] = 0;
  $node['status'] = 1;
  $node['uid'] = $user->uid;

  if ($filename) {
    $handle = fopen ($filename, "r");
    if ($handle) {
      $list = array();
      while (!feof ($handle)) {
        $line = fgets($handle);
        if (!strncmp ($line, "%", 1)) {
          $tag = substr($line, 0, 2);
          $value = trim(substr($line, 3));

          switch ($tag) {
            case '%0':

              $node_id = array_push($node_array, $node) - 1;
              switch ($value) {
                case "Journal Article": $node_array[$node_id]['biblio_type'] = 1;
                  break; // journal
                case "Conference Paper": $node_array[$node_id]['biblio_type'] = 2;
                  break;
                case "Conference Proceedings": $node_array[$node_id]['biblio_type'] = 3;
                  break; // conference proceedings 
                case "Report": $node_array[$node_id]['biblio_type'] = 5;
                  break; // report
                case "Book Section": $node_array[$node_id]['biblio_type'] = 6;
                  break; // book section
                case "Thesis": $node_array[$node_id]['biblio_type'] = 7;
                  break; // thesis
                case "Patent": $node_array[$node_id]['biblio_type'] = 8;
                  break; // patent
                case "Generic":
                default:
                  $node_array[$node_id]['biblio_type'] = 9;
                  break; // generic
              } 
              break;
            case '%A': 
              // $columns .= ", author";
              if ($node_array[$node_id]['biblio_authors']) $node_array[$node_id]['biblio_authors'] .= "; ";
              $node_array[$node_id]['biblio_authors'] .= "$value";
              break;
            case '%B':
              $node_array[$node_id]['biblio_secondary_title'] = $value;
              break;
            case '%C':
              $node_array[$node_id]['biblio_place_published'] = $value;
              break;
            case '%D':
              $node_array[$node_id]['biblio_year'] = $value;
              break;
            case '%E':
              if ($node_array[$node_id]['biblio_secondary_authors']) $node_array[$node_id]['biblio_secondary_authors'] .= "; ";
              $node_array[$node_id]['biblio_secondary_authors'] = $value;
              break;
            case '%F':
              $node_array[$node_id]['label'] = $value;
              break;
            case '%I':
              $node_array[$node_id]['biblio_publisher'] = $value;
              break;
            case '%J': // Journal
              $node_array[$node_id]['biblio_secondary_title'] = $value;
              break;
            case '%K':
              $node_array[$node_id]['biblio_keywords'] = $value;
              break;
            case '%L':
              $node_array[$node_id]['biblio_call_number'] = $value;
              break;
            case '%M': // accession_number
              $node_array[$node_id]['biblio_accession_number'] = $value;
              break;
            case '%N':
              $node_array[$node_id]['biblio_issue'] = $value;
              break;
            case '%P':
              $node_array[$node_id]['biblio_pages'] = $value;
              break;
            case '%S':
              $node_array[$node_id]['biblio_tertiary_title'] = $value;
              break;
            case '%T':
              $node_array[$node_id]['title'] = $value;
              break;
            case '%U':
              $node_array[$node_id]['biblio_url'] = $value;
              break;
            case '%V':
              $node_array[$node_id]['biblio_volume'] = $value;
              break;
            case '%X':
              $node_array[$node_id]['biblio_abst_e'] = $value;
              break;
            case '%Y':
              if ($node_array[$node_id]['biblio_tertiary_authors']) $node_array[$node_id]['biblio_tertiary_authors'] .= "; ";
              $node_array[$node_id]['biblio_tertiary_authors'] = $value;
              break;
            case '%Z':
              $node_array[$node_id]['biblio_notes'] = $value;
              break;
            case '%1': // CUSTOM 1
              break;
            case '%2':// CUSTOM 2
              break;
            case '%3':// CUSTOM 3
              break;
            case '%4':// CUSTOM 4
              break;
            case '%#':// CUSTOM 5
              break;
            case '%$':// CUSTOM 6
              break;
            case '%6':
              break;
            case '%7':
              $node_array[$node_id]['biblio_edition'] = $value;
              break;
            case '%8':
              $node_array[$node_id]['biblio_date'] = $value;
              break;
            case '%9':
              $node_array[$node_id]['biblio_type_of_work'] = $value;
              break;
            case '%?':
              break;
            case '%@':
              $node_array[$node_id]['biblio_isbn'] = $value;
              break;
            case '%!':
              break;
            case '%&':
              break;
            case '%(':
              break;
            case '%)':
              break;
            case '%*':
              break;
            case '%+':
              break;
            default:
              break;
          } //end switch
        } 
        /* end if (!strncmp ( $line, "%", 1)) */
      } 
      /* end while */

    } 
    /* end if($handle) */
  } 
  /* end if ($filename */
  if (function_exists('node_save')) {
    foreach ($node_array as $node) {
      $nodeid = node_save((object)$node);
      if ($nodeid) { 
         $content .= t('Successfully imported node' . l("$nodeid", "node/$nodeid")) . '<br>';
      }
    } 
    print theme('page', $content);
  } 
} 

function _endnote7_XML_import($filename = null) {
  global $user;
if (extension_loaded('domxml')) {

  if (!$dom = domxml_open_file($filename)) {
    echo "Error while parsing the document\n";
    return;
  } 
  
  $elements = array();
  $node_array = array();
  $node = array();
  $node['type'] = "biblio";
  $node['created'] = time();
  $node['changed'] = time();
  $node['comment'] = 0;
  $node['promote'] = 0;
  $node['moderate'] = 0;
  $node['sticky'] = 0;
  $node['format'] = 0;
  $node['status'] = 1;
  $node['uid'] = $user->uid;
  
  $xpath = xpath_new_context($dom);
  $record = $xpath->xpath_eval('//RECORD');
  foreach($record->nodeset as $rec) {
    $node_id = array_push($node_array, $node) - 1;
    $node_array[$node_id]['biblio_type'] = -2;
    $elements = $rec->get_elements_by_tagname('REFERENCE_TYPE');
    switch ((int) $elements[0]->get_content()) {
      case 0: // Journal Article
        $node_array[$node_id]['biblio_type'] = 1;
        break;
      case 2: // Thesis
        $node_array[$node_id]['biblio_type'] = 7;
        break;
      case 3: // Conference Proceeding
        $node_array[$node_id]['biblio_type'] = 2;
        break;
      case 7: // Book Section
        $node_array[$node_id]['biblio_type'] = 6;
        break;
      case 10: // Report
        $node_array[$node_id]['biblio_type'] = 5;
        break;
      case 15: // Patent
        $node_array[$node_id]['biblio_type'] = 8;
        break;
    } 
  
    $authors = "";
    $elements = $rec->get_elements_by_tagname('AUTHOR');
    foreach ($elements as $dom_node) {
      if ($authors) $authors .= "; ";
      $authors .= $dom_node->get_content();
    } 
  
    $node_array[$node_id]['biblio_authors'] = $authors;
    $sec_authors = "";
    $elements = $rec->get_elements_by_tagname('SECONDARY_AUTHOR');
    foreach ($elements as $dom_node) {
      if ($sec_authors) $sec_authors .= "; ";
      $sec_authors .= $dom_node->get_content();
    } 
    $node_array[$node_id]['biblio_secondary_authors'] = $sec_authors;
    $ter_authors = "";
    $elements = $rec->get_elements_by_tagname('TERTIARY_AUTHOR');
    foreach ($elements as $dom_node) {
      if ($ter_authors) $ter_authors .= "; ";
      $ter_authors .= $dom_node->get_content();
    } 
    $node_array[$node_id]['biblio_tertiary_authors'] = $ter_authors;
    $keywords = "";
    $elements = $rec->get_elements_by_tagname('KEYWORD');
    foreach ($elements as $dom_node) {
      if ($keywords) $keywords .= "; ";
      $keywords .= $dom_node->get_content();
    } 
    $node_array[$node_id]['biblio_keywords'] = $keywords;
    if ($elements = $rec->get_elements_by_tagname('YEAR')) 
      $node_array[$node_id]['biblio_year'] = (string)$elements[0]->get_content();
  
    if ($elements = $rec->get_elements_by_tagname('TITLE')) 
      $node_array[$node_id]['title'] = (string)$elements[0]->get_content();
  
    if ($elements = $rec->get_elements_by_tagname('PUBLISHER')) 
      $node_array[$node_id]['biblio_publisher'] = (string)$elements[0]->get_content();
      
    if ($elements = $rec->get_elements_by_tagname('ISBN')) 
      $node_array[$node_id]['biblio_isbn'] = (string)$elements[0]->get_content();
      
    if ($elements = $rec->get_elements_by_tagname('SECONDARY_TITLE')) 
      $node_array[$node_id]['biblio_secondary_title'] = (string)$elements[0]->get_content();
      
    if ($elements = $rec->get_elements_by_tagname('VOLUME')) 
      $node_array[$node_id]['biblio_volume'] = (string)$elements[0]->get_content();
      
    if ($elements = $rec->get_elements_by_tagname('PAGES')) 
      $node_array[$node_id]['biblio_pages'] = (string)$elements[0]->get_content();
      
    if ($elements = $rec->get_elements_by_tagname('ABSTRACT')) 
      $node_array[$node_id]['biblio_abst_e'] = (string)$elements[0]->get_content();
      
    if ($elements = $rec->get_elements_by_tagname('URL')) 
      $node_array[$node_id]['biblio_url'] = (string)$elements[0]->get_content();
  
    if ($elements = $rec->get_elements_by_tagname('NUMBER')) 
      $node_array[$node_id]['biblio_number'] = (string)$elements[0]->get_content();
  
    if ($elements = $rec->get_elements_by_tagname('NOTES')) 
      $node_array[$node_id]['biblio_notes'] = (string)$elements[0]->get_content();
  
    if ($elements = $rec->get_elements_by_tagname('PLACE_PUBLISHED')) 
      $node_array[$node_id]['biblio_place_published'] = (string)$elements[0]->get_content();
  
    if ($elements = $rec->get_elements_by_tagname('DATE')) 
      $node_array[$node_id]['biblio_date'] = (string)$elements[0]->get_content();
  } 
  if (function_exists('node_save')) {
    $content = "";
    foreach ($node_array as $node) {
      $node_id = node_save((object)$node);
      if ($node_id) { 
         $content .= t('Successfully imported node' . l("$node_id", "node/$node_id")) . '<br>';
      }
    } 
    if (!$content) drupal_set_message("No records were successfully imported", 'error');

    print theme('page', $content);
  } 
 }else{
   print theme("page","DOMXML php extension is not loaded, so you cannot import files in XML format");
}

} 

function biblio_get_db_fields() {
return array('nid', 'biblio_type', 'biblio_number', 'biblio_other_number',
  'biblio_secondary_title', 'biblio_tertiary_title', 'biblio_authors',
  'biblio_secondary_authors', 'biblio_tertiary_authors', 'biblio_corp_author',
  'biblio_other_author_affiliations', 'biblio_edition', 'biblio_publisher',
  'biblio_place_published', 'biblio_year', 'biblio_volume', 'biblio_issue', 'biblio_pages', 'biblio_date',
  'biblio_isbn', 'biblio_lang', 'biblio_abst_e', 'biblio_abst_f',
  'biblio_full_text', 'biblio_keywords', 'biblio_url', 'biblio_call_number',
  'biblio_accession_number', 'biblio_type_of_work', 'biblio_notes');
} 
function _author_links($author) {
if (isset($_GET['sort'])) {
  $sort = "?sort=" . $_GET['sort'];
} 

$html = "";
$author_array = explode(";", $author);
foreach($author_array as $auth) {
  if ($i) $html .= "; ";
  $i++;
  if (strstr($auth, ",")) {
    $parts = split(",", $auth);
    $lastname = $parts[0];
  } else {
    $parts = split(" ", $auth);
    $lastname = end($parts);
  } 
  // list($lastname, $init) = split(",", $auth);
  $html .= l(trim($auth), 'biblio/author/' . trim($lastname) . $sort);
} 
return $html;
} 
function _parse_authors($authors) {
$and = array(" and", " And", " AND");
$authors = str_replace($and, ", ", $authors); // change the word "and" to a comma
$authors = str_replace(" ,", ",", $authors); // fix some potential typos
$authors = str_replace(",,", ",", $authors); // ditto 
// $authors = str_replace(";",",",$authors);
$chunks = explode(";", $authors); // split the authors on the semicolon
$num_chunks = count($chunks);
// print_r($chunks);
for($i = 0;
  $i < count($chunks);
  $i++) {
  $suffix = _get_suffix($chunks[$i]); // get and strip out the suffix
  $prefix = _get_prefix($chunks[$i]); // get and strip out the prefix
  if (strstr($chunks[$i], ",")) { // we probably have lastname first
    $subchunks = explode(",", trim($chunks[$i]));
    $lastname = $subchunks[0];
    $subchunks = explode(" ", trim($subchunks[1]));
    $initials = "";
    for ($j = 0;
      $j < count($subchunks) ;
      $j++) {
      if (substr_count($subchunks[$j], '.')) {
        $initials .= $subchunks[$j];
      } else {
        $initials .= substr($subchunks[$j], 0, 1) . ".";
      } 
    } 
  } else { // we have some form of firstname first (Fistname I. Lastname)
    $subchunks = explode(" ", trim($chunks[$i]));
    $lastname = end($subchunks);
    $initials = "";
    for ($j = 0;
      $j < count($subchunks) - 1 ;
      $j++) {
      if (substr_count($subchunks[$j], '.')) {
        $initials .= $subchunks[$j];
      } else {
        $initials .= substr($subchunks[$j], 0, 1) . ".";
      } 
    } 
  } 
  $chunks[$i] = trim($prefix . ' ' . $lastname . ', ' . $initials . ' ' . $suffix);
} 
return implode("; ", $chunks);
} 
function _get_suffix(&$name) {
$suffix = null;
if (preg_match("/[, \.]+(Jr|Sr|Snr)\.?\s*$/", $name, $match)) {
  $suffix = $match[0];
  $Text = str_replace($Suffix, "", $name);
} elseif (preg_match("/([, \.]+)(Jr|Sr|Snr)[. ]/", $name, $match)) {
  $suffix = $match[1];
  $name = str_replace($Suffix, "", $name);
} 

return $suffix;
} 
function _get_prefix(&$name) {
$prefix = null;
$name = " " . $name;
$prefs = array(" Van ", " van ", " von ", " den ", " der ", " de ", " De ", " ter ", " Ter ", "Vander ");
if (strstr($name, " Van ")) $prefix .= "Van ";
if (strstr($name, " van ")) $prefix .= "van ";
if (strstr($name, " Vander ")) $prefix .= "Vander ";
if (strstr($name, " von ")) $prefix .= "von ";
if (strstr($name, " de ")) $prefix .= "de ";
if (strstr($name, " De ")) $prefix .= "De ";
if (strstr($name, " den ")) $prefix .= "den ";
if (strstr($name, " der ")) $prefix .= "der ";
if (strstr($name, " ter ")) $prefix .= "ter ";
if (strstr($name, " Ter ")) $prefix .= "Ter ";
if (strlen($prefix)) $name = str_replace($prefs, "", $name);
$name = trim($name);
return $prefix;
} 

