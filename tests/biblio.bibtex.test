<?php

/**
 * Test BibTeX style plugin.
 */
class BiblioBibtex extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'BibTeX',
      'description' => 'Test BibTeX style plugin.',
      'group' => 'Biblio',
    );
  }

  function setUp() {
    parent::setUp('biblio');

    $field_names = array(
      'biblio_abstract',
      'biblio_citekey',
      'biblio_edition',
      'biblio_first_letter',
      'biblio_image',
      'biblio_in_press',
      'biblio_issued',
      'biblio_pages',
      'biblio_place_published',
      'biblio_publisher',
      'biblio_secondary_title',
      'biblio_tertiary_title',
      'biblio_year',
      // Contributors reference.
      'contributor_field_collection',
    );

    foreach ($field_names as $field_name) {
      biblio_create_field($field_name, 'biblio', 'book');
    }

    $field_names = array(
      'contributor_given',
      'contributor_family',
    );

    foreach ($field_names as $field_name) {
      biblio_create_field($field_name, 'biblio_contributor', 'biblio_contributor');
      biblio_create_field($field_name, 'biblio_contributor', 'biblio_contributor');
    }

    biblio_create_field('biblio_contributor_role', 'field_collection_item', 'contributor_field_collection');
    biblio_create_field('biblio_contributor', 'field_collection_item', 'contributor_field_collection');
  }

  /**
   * Test Import.
   */
  function testImport() {
    ctools_include('plugins');

    $plugin = biblio_get_biblio_style('bibtex');
    $class = ctools_plugin_load_class('biblio', 'biblio_style', 'bibtex', 'class');

    $biblio_style = new $class($plugin);
    $data = '
@Book{abramowitz+stegun,
  author    = "Milton {Abramowitz} and Irene A. {Stegun}",
  title     = "Handbook of Mathematical Functions with Formulas, Graphs, and Mathematical Tables",
  publisher = "Dover",
  year      =  1964,
  address   = "New York",
  edition   = "ninth Dover printing, tenth GPO printing"
}';

    $biblios = $biblio_style->import($data);
    $biblio = $biblios[0];

    $expected_result = '
@Book{abramowitz+stegun,
	title = "Handbook of Mathematical Functions with Formulas, Graphs, and Mathematical Tables",
	year = "1964",
	publisher = "Dover",
	edition = "ninth Dover printing, tenth GPO printing",
	address = "New York",
	author = "Milton {Abramowitz} and  Irene A. {Stegun}"
}';

    $output = $biblio->getText('bibtex', array('opening_tag' => '"', 'closing_tag' => '"'));

    // We use trim, to remove whitespace.
    $this->assertEqual(trim($output), trim($expected_result));
  }
}
