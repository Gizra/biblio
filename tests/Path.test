<?php

/**
 * @file
 * Tests for the integration with the Path module.
 */

/**
 * Provides a base class for testing the Path module.
 *
 * @see PathTestCase
 */
class BiblioPathTestCase extends DrupalWebTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Path alias functionality',
      'description' => 'Add, edit, delete, and change alias and verify its consistency in the database.',
      'group' => 'Bilbio',
    );
  }

  function setUp() {
    parent::setUp('path', 'biblio_ui');
    biblio_create_fields_by_bundle(array('book'));

    // Create test user and login.
    $web_user = $this->drupalCreateUser(array('create page content', 'edit own page content', 'administer url aliases', 'create url aliases'));
    $this->drupalLogin($web_user);
  }

  /**
   * Tests alias functionality through the biblio interfaces.
   */
  function testBiblioAlias() {
    // Create test node.
    $bilbio1 = biblio_create('book', array('title' => 'biblio1'));
    $bilbio1->save();

    // Create alias.
    $edit = array();
    $edit['path[alias]'] = $this->randomName(8);
    $this->drupalPost('bilbio/' . $bilbio1->bid . '/edit', $edit, t('Save'));

    // Confirm that the alias works.
    $this->drupalGet($edit['path[alias]']);
    $this->assertText($bilbio1->title, 'Alias works.');
    $this->assertResponse(200);

    // Change alias to one containing "exotic" characters.
    $previous = $edit['path[alias]'];
    $edit['path[alias]'] = "- ._~!$'\"()*@[]?&+%#,;=:" . // "Special" ASCII characters.
      "%23%25%26%2B%2F%3F" . // Characters that look like a percent-escaped string.
      "éøïвβ中國書۞"; // Characters from various non-ASCII alphabets.
    $this->drupalPost('bilbio/' . $bilbio1->bid . '/edit', $edit, t('Save'));

    // Confirm that the alias works.
    $this->drupalGet($edit['path[alias]']);
    $this->assertText($bilbio1->title, 'Changed alias works.');
    $this->assertResponse(200);

    // Make sure that previous alias no longer works.
    $this->drupalGet($previous);
    $this->assertNoText($bilbio1->title, 'Previous alias no longer works.');
    $this->assertResponse(404);

    // Create second test node.
    $bilbio2 = biblio_create('book', array('title' => 'biblio2'));
    $bilbio2->save();

    // Set alias to second test node.
    // Leave $edit['path[alias]'] the same.
    $this->drupalPost('bilbio/' . $bilbio2->bid . '/edit', $edit, t('Save'));

    // Confirm that the alias didn't make a duplicate.
    $this->assertText(t('The alias is already in use.'), 'Attempt to moved alias was rejected.');

    // Delete alias.
    $this->drupalPost('bilbio/' . $bilbio1->bid . '/edit', array('path[alias]' => ''), t('Save'));

    // Confirm that the alias no longer works.
    $this->drupalGet($edit['path[alias]']);
    $this->assertNoText($bilbio1->title, 'Alias was successfully deleted.');
    $this->assertResponse(404);
  }
}