<?php
// $Id$
/*
 * @file
 * Base class for all biblio tests
 */
class BiblioWebTestCase extends DrupalWebTestCase {
  public $kids = array();  //keep a list of all keyword id's created
  public $cids = array();  //keep a list of all contributor id's created
  public $nids = array();  //keep a list of all node id's created
  public $admin_user;

 function tearDown() {
    // remove any keywords created during the testing
    if(!empty($this->kids)){
      db_delete('biblio_keyword')
        ->condition('kid', $this->kids, 'IN')
        ->execute();

      db_delete('biblio_keyword_data')
        ->condition('kid', $this->kids, 'IN')
        ->execute();

    }
    $this->kids = array();

    foreach($this->nids as $nid) {
      node_delete($nid);
    }
    $this->nids = array();

    foreach($this->cids as $cid) {
      biblio_delete_contributor($cid);
    }
    $this->cids = array();

    parent::tearDown();
  }

  function createNode($type = 100) {
    $schema = drupal_get_schema('biblio');
    foreach($schema['fields'] as $name => $values) {
      if ($values['type'] == 'int') continue;
      switch ($values['type']) {
        case 'varchar':
          $length = $values['length'];
          break;
        case 'text':
          $length = 1000;
          break;
      }
      $biblio_fields["$name"] = $name;
    }
    $settings = array(
      'title' => array(FIELD_LANGUAGE_NONE => array(array('value' => 'Biblio Title'))),
      'type' => 'biblio', // This replaces the default type
      'biblio_type' => $type, // This appends a new field.
      'biblio_year' => 2009,
    );
    $settings = array_merge($biblio_fields, $settings);

    $node = $this->drupalCreateNode($settings);
    $node->biblio_contributors[1][] = array('name' => 'Ron J. Jeromezzzzzz',  'auth_type' => 1);
    $node->biblio_contributors[1][] = array('name' => 'John Smithzzzzzz',     'auth_type' => 1);
    $node->biblio_contributors[1][] = array('name' => 'George W. Bushzzzzzz', 'auth_type' => 1);
    biblio_insert_contributors($node);
    $node = node_load($node->nid, NULL, TRUE);
    foreach($node->biblio_contributors[1] as $author) {
      $this->cids[] = $author['cid'];
    }

    $this->nids[] = $node->nid;

    return $node;

  }
  function assertBiblioFields($node1, $node2, $skip_fields = array()) {
    $fields = drupal_schema_fields_sql('biblio');
    $fields = array_diff($fields, $skip_fields);
    $count = 0;
    foreach($fields as $field) {
      if ($node1->$field != $node2->$field) {
        $this->assertIdentical($node1->$field, $node2->$field);
        $count++;
      }
    }
    $this->assertEqual($count, 0, "There were $count differences between the two nodes");
  }
}